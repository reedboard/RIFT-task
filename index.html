<!DOCTYPE html>
<html>
<head>
  <title>SHAT Task</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    .arena-item:hover {
      cursor: pointer;
      opacity: 0.8;
    }
    .stimulus-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
    }
    .stimulus-option {
      text-align: center;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      min-width: 200px;
    }
    .fractal-placeholder {
      width: 150px;
      height: 150px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      margin: 0 auto 10px auto;
    }
  </style>
</head>
<body></body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => {
      console.log("Experiment completed");
      jsPsych.data.displayData();
    }
  });

  let timeline = [];

  // Define reward ranges (ensuring no overlap for clear learning)
  const rewardRanges = [
    [1, 5], [6, 10], [11, 15], [16, 20], [21, 25], [26, 30], [31, 35], [36, 40],
    [41, 45], [46, 50], [51, 55], [56, 60], [61, 65], [66, 70], [71, 75]
  ];

  // Create stimulus pool with placeholder fractals (using CSS gradients)
  const stimulusColors = [
    '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#a55eea', '#26de81', '#fd79a8',
    '#fdcb6e', '#6c5ce7', '#00b894', '#e84393', '#fdcb6e', '#74b9ff', '#00cec9',
    '#fd79a8'
  ];

  let stimulus_pool = [];
  for (let i = 0; i < 15; i++) {
    stimulus_pool.push({
      id: `fractal_${i + 1}`,
      color: stimulusColors[i],
      unlocked: false,
      reward_range: null
    });
  }

  // Shuffle the stimulus pool
  stimulus_pool = jsPsych.randomization.shuffle(stimulus_pool);
  
  let unlocked_stimuli = [];
  let used_reward_ranges = [];

  // Function to create fractal HTML
  function createFractalHTML(stimulus, width = 150) {
    return `<div class="fractal-placeholder" style="width: ${width}px; height: ${width}px; background: linear-gradient(45deg, ${stimulus.color}, ${adjustColor(stimulus.color, -30)});">${stimulus.id.split('_')[1]}</div>`;
  }

  // Function to adjust color brightness
  function adjustColor(color, amount) {
    const usePound = color[0] === "#";
    const col = usePound ? color.slice(1) : color;
    const num = parseInt(col, 16);
    let r = (num >> 16) + amount;
    let g = (num >> 8 & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;
    r = r > 255 ? 255 : r < 0 ? 0 : r;
    g = g > 255 ? 255 : g < 0 ? 0 : g;
    b = b > 255 ? 255 : b < 0 ? 0 : b;
    return (usePound ? "#" : "") + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
  }

  // Function to assign reward range
  function assignRewardRange() {
    const availableRanges = rewardRanges.filter(range => 
      !used_reward_ranges.some(used => used[0] === range[0] && used[1] === range[1])
    );
    
    if (availableRanges.length === 0) {
      // If all ranges are used, reset and reuse
      used_reward_ranges = [];
      return rewardRanges[Math.floor(Math.random() * rewardRanges.length)];
    }
    
    const selected = availableRanges[Math.floor(Math.random() * availableRanges.length)];
    used_reward_ranges.push(selected);
    return selected;
  }

  // Instructions
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="max-width: 600px; margin: 0 auto; text-align: center;">
        <h2>Welcome to the SHAT Task</h2>
        <p>In this experiment, you will make choices between known and unknown reward options.</p>
        <br>
        <p><strong>Instructions:</strong></p>
        <p>• You'll see two options on each trial</p>
        <p>• <strong>Known options</strong> show their point range</p>
        <p>• <strong>Unknown options</strong> show "???" - selecting them reveals their value for future trials</p>
        <br>
        <p><strong>Controls:</strong></p>
        <p><strong>Press F</strong> to select the LEFT option</p>
        <p><strong>Press J</strong> to select the RIGHT option</p>
        <br>
        <p>After several trials, you'll enter an Arena where you can choose the best options.</p>
        <p><strong>Press any key to begin</strong></p>
      </div>
    `,
    choices: "ALL_KEYS"
  });

  // First trial: force learning by presenting two unknowns
  if (stimulus_pool.length >= 2) {
    const unknown1 = stimulus_pool[0];
    const unknown2 = stimulus_pool[1];

    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="stimulus-container">
          <div class="stimulus-option">
            ${createFractalHTML(unknown1)}
            <p style="font-size: 18px; font-weight: bold;">???</p>
            <p><strong>F: CHOOSE LEFT</strong></p>
          </div>
          <div class="stimulus-option">
            ${createFractalHTML(unknown2)}
            <p style="font-size: 18px; font-weight: bold;">???</p>
            <p><strong>J: CHOOSE RIGHT</strong></p>
          </div>
        </div>
      `,
      choices: ['f', 'j'],
      data: {
        trial_type: 'forced_learning',
        trial_number: 0,
        left_stimulus: unknown1.id,
        right_stimulus: unknown2.id
      },
      on_finish: function(data) {
        const chosen = data.response === 'f' ? unknown1 : unknown2;
        const assigned_range = assignRewardRange();
        
        chosen.unlocked = true;
        chosen.reward_range = assigned_range;
        unlocked_stimuli.push(chosen);
        
        data.chosen_stimulus = chosen.id;
        data.assigned_range = assigned_range;
        
        console.log(`Unlocked stimulus ${chosen.id} with range [${assigned_range[0]}, ${assigned_range[1]}]`);
      }
    });

    // Feedback for first trial
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const lastTrial = jsPsych.data.get().last(1).values()[0];
        const range = lastTrial.assigned_range;
        return `
          <div style="text-align: center;">
            <h3>Stimulus Unlocked!</h3>
            <p>This fractal will give you <strong>${range[0]} to ${range[1]} points</strong> in future trials.</p>
            <p><em>Press any key to continue</em></p>
          </div>
        `;
      },
      choices: "ALL_KEYS"
    });
  }

  // Main choice trials (known vs unknown)
  for (let i = 1; i <= 12; i++) {
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        // Get available stimuli
        const available_unlocked = unlocked_stimuli.filter(s => s.unlocked);
        const available_unknown = stimulus_pool.filter(s => !s.unlocked);
        
        if (available_unlocked.length === 0 || available_unknown.length === 0) {
          return "<p>No more stimuli available. Press any key to continue.</p>";
        }
        
        // Randomly select one known and one unknown
        const known = jsPsych.randomization.sampleWithoutReplacement(available_unlocked, 1)[0];
        const unknown = jsPsych.randomization.sampleWithoutReplacement(available_unknown, 1)[0];
        
        // Store current stimuli for the trial
        jsPsych.data.addProperties({
          current_known: known,
          current_unknown: unknown
        });
        
        return `
          <div class="stimulus-container">
            <div class="stimulus-option">
              ${createFractalHTML(known)}
              <p style="font-size: 16px; font-weight: bold;">${known.reward_range[0]}–${known.reward_range[1]} Points</p>
              <p><strong>F: ACCEPT REWARD</strong></p>
            </div>
            <div class="stimulus-option">
              ${createFractalHTML(unknown)}
              <p style="font-size: 18px; font-weight: bold;">???</p>
              <p><strong>J: REVEAL REWARD</strong></p>
            </div>
          </div>
        `;
      },
      choices: ['f', 'j'],
      data: {
        trial_type: 'choice',
        trial_number: i
      },
      on_finish: function(data) {
        const props = jsPsych.data.get().last(1).values()[0];
        const known = props.current_known;
        const unknown = props.current_unknown;
        
        if (!known || !unknown) {
          data.error = "Missing stimulus data";
          return;
        }
        
        data.known_stimulus = known.id;
        data.known_range = known.reward_range;
        data.unknown_stimulus = unknown.id;
        
        if (data.response === 'j') {
          // Chose to reveal unknown
          const assigned_range = assignRewardRange();
          unknown.unlocked = true;
          unknown.reward_range = assigned_range;
          unlocked_stimuli.push(unknown);
          
          data.choice = 'reveal';
          data.revealed = true;
          data.assigned_range = assigned_range;
          data.points_awarded = 0;
          
          console.log(`Trial ${i}: Revealed ${unknown.id} with range [${assigned_range[0]}, ${assigned_range[1]}]`);
        } else {
          // Chose known reward
          const [min, max] = known.reward_range;
          const points = Math.floor(Math.random() * (max - min + 1)) + min;
          
          data.choice = 'accept';
          data.revealed = false;
          data.points_awarded = points;
          
          console.log(`Trial ${i}: Accepted ${known.id}, awarded ${points} points`);
        }
      }
    });

    // Feedback after each trial
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const lastTrial = jsPsych.data.get().last(1).values()[0];
        let feedback = "";
        
        if (lastTrial.choice === 'reveal') {
          const range = lastTrial.assigned_range;
          feedback = `
            <div style="text-align: center;">
              <h3>New Stimulus Unlocked!</h3>
              <p>This fractal will give you <strong>${range[0]} to ${range[1]} points</strong> in future trials.</p>
              <p>You gained <strong>0 points</strong> this trial.</p>
            </div>
          `;
        } else {
          feedback = `
            <div style="text-align: center;">
              <h3>Reward Collected!</h3>
              <p>You earned <strong>${lastTrial.points_awarded} points</strong> this trial.</p>
            </div>
          `;
        }
        
        feedback += `
          <p style="text-align: center;"><em>Press any key to continue</em></p>
        `;
        
        return feedback;
      },
      choices: "ALL_KEYS"
    });
  }

  // Arena instructions
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="text-align: center; max-width: 600px; margin: 0 auto;">
        <h2>🏟️ Welcome to the Arena! 🏟️</h2>
        <p>Now you can choose from all the fractals you've unlocked.</p>
        <p><strong>Select exactly 3 fractals</strong> to maximize your points.</p>
        <p>Click on fractals to select them (they'll turn green when selected).</p>
        <p>Choose wisely - higher reward ranges give more points!</p>
        <p><em>Press any key to enter the Arena</em></p>
      </div>
    `,
    choices: "ALL_KEYS"
  });

  // Arena trial
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
      const available_stimuli = unlocked_stimuli.filter(s => s.unlocked);
      
      if (available_stimuli.length === 0) {
        return "<p>No unlocked stimuli available for the Arena.</p>";
      }
      
      let html = `
        <h2 style="text-align: center;">🏟️ Arena - Select 3 Fractals 🏟️</h2>
        <div id="arena" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px 0;">
      `;
      
      available_stimuli.forEach((stim, index) => {
        html += `
          <div class="arena-item" data-index="${index}" style="border: 3px solid #ccc; padding: 10px; border-radius: 10px; cursor: pointer;">
            ${createFractalHTML(stim, 120)}
            <p style="text-align: center; margin: 5px 0; font-weight: bold;">${stim.reward_range[0]}–${stim.reward_range[1]} pts</p>
          </div>
        `;
      });
      
      html += `</div>`;
      html += `
        <div id="selection-counter" style="text-align: center; margin: 10px 0;">
          <p>Selected: <span id="count">0</span>/3</p>
        </div>
        <div id="arena-submit" style="text-align: center; margin-top: 20px; display: none;">
          <button id="submit-selection" style="padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Submit Selection</button>
        </div>
      `;
      
      return html;
    },
    choices: "NO_KEYS",
    on_load: function() {
      let selectedIndices = [];
      const available_stimuli = unlocked_stimuli.filter(s => s.unlocked);
      
      document.querySelectorAll(".arena-item").forEach(item => {
        item.addEventListener("click", () => {
          const index = parseInt(item.dataset.index);
          
          if (selectedIndices.includes(index)) {
            // Deselect
            selectedIndices = selectedIndices.filter(i => i !== index);
            item.style.border = "3px solid #ccc";
            item.style.backgroundColor = "transparent";
          } else if (selectedIndices.length < 3) {
            // Select
            selectedIndices.push(index);
            item.style.border = "3px solid #4CAF50";
            item.style.backgroundColor = "#e8f5e8";
          }
          
          // Update counter
          document.getElementById("count").textContent = selectedIndices.length;
          
          // Show/hide submit button
          document.getElementById("arena-submit").style.display =
            selectedIndices.length === 3 ? "block" : "none";
        });
      });
      
      document.getElementById("submit-selection").addEventListener("click", () => {
        const selected_stimuli = selectedIndices.map(i => available_stimuli[i]);
        
        // Calculate points for each selection
        const points = selected_stimuli.map(stim => {
          const [min, max] = stim.reward_range;
          return Math.floor(Math.random() * (max - min + 1)) + min;
        });
        
        const totalPoints = points.reduce((a, b) => a + b, 0);
        
        jsPsych.finishTrial({
          trial_type: 'arena',
          selected_stimuli: selected_stimuli.map(s => s.id),
          selected_ranges: selected_stimuli.map(s => s.reward_range),
          awarded_points: points,
          total_points: totalPoints
        });
      });
    }
  });

  // Final results
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
      const arena_data = jsPsych.data.get().last(1).values()[0];
      const allData = jsPsych.data.get().values();
      const totalPointsEarned = allData
        .filter(trial => trial.points_awarded)
        .reduce((sum, trial) => sum + trial.points_awarded, 0);
      
      return `
        <div style="text-align: center; max-width: 600px; margin: 0 auto;">
          <h2>🎉 Experiment Complete! 🎉</h2>
          <h3>Arena Results:</h3>
          <p>You earned <strong>${arena_data.total_points}</strong> points in the Arena!</p>
          <p>Individual selections: ${arena_data.awarded_points.join(', ')} points</p>
          <h3>Total Experiment Points:</h3>
          <p>Arena: <strong>${arena_data.total_points}</strong> points</p>
          <p>Learning phase: <strong>${totalPointsEarned}</strong> points</p>
          <p><strong>Grand Total: ${totalPointsEarned + arena_data.total_points} points</strong></p>
          <br>
          <p>Thank you for participating!</p>
        </div>
      `;
    },
    choices: ['View Data', 'Finish']
  });

  // Run the experiment
  jsPsych.run(timeline);
</script>
</html>
