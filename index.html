<!DOCTYPE html>
<html>
<head>
  <title>SHAT Task</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    .arena-item:hover {
      cursor: pointer;
      opacity: 0.8;
    }
    .stimulus-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
    }
    .stimulus-option {
      text-align: center;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      min-width: 200px;
    }
    .countdown-display {
      position: fixed;
      top: 50px;
      right: 70px;
      background: #f0f0f0;
      padding: 10px 15px;
      border-radius: 8px;
      border: 2px solid #fa0101;
      font-weight: bold;
      font-size: 25px;
    }
    .arena-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 15px;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }
    .arena-fractal {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border: 3px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .arena-fractal:hover {
      opacity: 0.8;
    }
    .arena-fractal.selected {
      border-color: #2196F3;
      background-color: #e3f2fd;
    }
    .arena-fractal.known {
      border-color: #4CAF50;
    }
    .arena-fractal.unknown {
      border-color: #FF9800;
    }
  </style>
</head>
<body></body>
<script>
  const jsPsych = initJsPsych({
    on_finish: () => {
      console.log("Experiment completed");
      jsPsych.data.displayData();
    }
  });

  let timeline = [];

  // Define reward ranges (ensuring no overlap for clear learning)
  const rewardRanges = [
    [1, 5], [6, 10], [11, 15], [16, 20], [21, 25], [26, 30], [31, 35], [36, 40],
    [41, 45], [46, 50], [51, 55], [56, 60], [61, 65], [66, 70], [71, 75], [76, 80],
    [81, 85], [86, 90], [91, 95], [96, 100], [101, 105], [106, 110], [111, 115],
    [116, 120], [121, 125], [126, 130], [131, 135], [136, 140], [141, 145], [146, 150],
    [151, 155], [156, 160], [161, 165], [166, 170], [171, 175], [176, 180], [181, 185],
    [186, 190], [191, 195], [196, 200], [201, 250], [251, 300]
  ];

  // Fractal image filenames - using first 42 for the arena
  const fractalFilenames = [
    'SHINEd_fractal_001.png', 'SHINEd_fractal_002.png', 'SHINEd_fractal_004.png',
    'SHINEd_fractal_005.png', 'SHINEd_fractal_006.png', 'SHINEd_fractal_013.png',
    'SHINEd_fractal_016.png', 'SHINEd_fractal_021.png', 'SHINEd_fractal_022.png',
    'SHINEd_fractal_034.png', 'SHINEd_fractal_047.png', 'SHINEd_fractal_049.png',
    'SHINEd_fractal_056.png', 'SHINEd_fractal_076.png', 'SHINEd_fractal_078.png',
    'SHINEd_fractal_087.png', 'SHINEd_fractal_1005.png', 'SHINEd_fractal_1007.png',
    'SHINEd_fractal_101.png', 'SHINEd_fractal_1013.png', 'SHINEd_fractal_1017.png',
    'SHINEd_fractal_1018.png', 'SHINEd_fractal_1019.png', 'SHINEd_fractal_1020.png',
    'SHINEd_fractal_1021.png', 'SHINEd_fractal_1022.png', 'SHINEd_fractal_1029.png',
    'SHINEd_fractal_103.png', 'SHINEd_fractal_1046.png', 'SHINEd_fractal_1048.png',
    'SHINEd_fractal_105.png', 'SHINEd_fractal_1058.png', 'SHINEd_fractal_106.png',
    'SHINEd_fractal_1061.png', 'SHINEd_fractal_1062.png', 'SHINEd_fractal_1077.png',
    'SHINEd_fractal_1079.png', 'SHINEd_fractal_1080.png', 'SHINEd_fractal_1087.png',
    'SHINEd_fractal_1090.png', 'SHINEd_fractal_1094.png', 'SHINEd_fractal_1103.png',
    'SHINEd_fractal_1108.png'
  ];

  // Create stimulus pool with actual fractal images (42 total for arena)
  let all_stimuli = fractalFilenames.map((filename, index) => ({
    id: `fractal_${index + 1}`,
    image: `stimuli_400_fractals/${filename}`,
    unlocked: false,
    reward_range: null,
    available_for_learning: index < 21 // First 21 available for learning phase
  }));

  // Shuffle only the learning stimuli
  let learning_stimuli = all_stimuli.filter(s => s.available_for_learning);
  learning_stimuli = jsPsych.randomization.shuffle(learning_stimuli);
  
  let unlocked_stimuli = [];
  let used_reward_ranges = [];

  // Preload images
  timeline.push({
    type: jsPsychPreload,
    images: all_stimuli.map(s => s.image)
  });

  // Function to create fractal HTML
  function createFractalHTML(stimulus, width = 150) {
    return `<img src="${stimulus.image}" width="${width}" height="${width}" style="border-radius: 10px;">`;
  }

  // Function to assign reward range
  function assignRewardRange() {
    const availableRanges = rewardRanges.filter(range => 
      !used_reward_ranges.some(used => used[0] === range[0] && used[1] === range[1])
    );
    
    if (availableRanges.length === 0) {
      // If all ranges are used, reset and reuse
      used_reward_ranges = [];
      return rewardRanges[Math.floor(Math.random() * rewardRanges.length)];
    }
    
    const selected = availableRanges[Math.floor(Math.random() * availableRanges.length)];
    used_reward_ranges.push(selected);
    return selected;
  }

  // Instructions
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="max-width: 500px; margin: 0 auto; text-align: center;">
        <h2>SHAT Task</h2>
        <p>Choose between known and unknown reward options. Known options show point ranges, unknown options show "???" but reveal their value when selected.</p>
        <p><strong>Press F for LEFT, J for RIGHT</strong></p>
        <p>After a series of trials, you'll enter <strong>the Arena<strong>.</p>
        <p><strong>Press any key to begin</strong></p>
      </div>
    `,
    choices: "ALL_KEYS"
  });

  // First trial: force learning by presenting two unknowns from learning pool
  if (learning_stimuli.length >= 2) {
    const unknown1 = learning_stimuli[0];
    const unknown2 = learning_stimuli[1];

    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="countdown-display">Trials to Arena: 21</div>
        <div class="stimulus-container">
          <div class="stimulus-option">
            ${createFractalHTML(unknown1)}
            <p style="font-size: 18px; font-weight: bold;">???</p>
            <p><strong>F: CHOOSE LEFT</strong></p>
          </div>
          <div class="stimulus-option">
            ${createFractalHTML(unknown2)}
            <p style="font-size: 18px; font-weight: bold;">???</p>
            <p><strong>J: CHOOSE RIGHT</strong></p>
          </div>
        </div>
      `,
      choices: ['f', 'j'],
      data: {
        trial_type: 'forced_learning',
        trial_number: 0,
        left_stimulus: unknown1.id,
        right_stimulus: unknown2.id
      },
      on_finish: function(data) {
        const chosen = data.response === 'f' ? unknown1 : unknown2;
        const assigned_range = assignRewardRange();
        
        chosen.unlocked = true;
        chosen.reward_range = assigned_range;
        unlocked_stimuli.push(chosen);
        
        data.chosen_stimulus = chosen.id;
        data.assigned_range = assigned_range;
        
        console.log(`Unlocked stimulus ${chosen.id} with range [${assigned_range[0]}, ${assigned_range[1]}]`);
      }
    });

    // Feedback for first trial
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const lastTrial = jsPsych.data.get().last(1).values()[0];
        const range = lastTrial.assigned_range;
        return `
          <div style="text-align: center;">
            <h3>Stimulus Unlocked!</h3>
            <p>This fractal will give you <strong>${range[0]} to ${range[1]} points</strong> in future trials.</p>
            <p><em>Press any key to continue</em></p>
          </div>
        `;
      },
      choices: "ALL_KEYS"
    });
  }

  // Main choice trials (20 more trials, for 21 total)
  for (let i = 1; i <= 20; i++) {
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        // Get available stimuli from learning pool only
        const available_unlocked = unlocked_stimuli.filter(s => s.unlocked && s.available_for_learning);
        const available_unknown = learning_stimuli.filter(s => !s.unlocked);
        
        const trialsLeft = 21 - i;
        
        if (available_unlocked.length === 0 || available_unknown.length === 0) {
          return `
            <div class="countdown-display">Trials to Arena: ${trialsLeft}</div>
            <p>No more stimuli available. Press any key to continue.</p>
          `;
        }
        
        // Randomly select one known and one unknown
        const known = jsPsych.randomization.sampleWithoutReplacement(available_unlocked, 1)[0];
        const unknown = jsPsych.randomization.sampleWithoutReplacement(available_unknown, 1)[0];
        
        // Store current stimuli for the trial
        jsPsych.data.addProperties({
          current_known: known,
          current_unknown: unknown
        });
        
        return `
          <div class="countdown-display">Trials to Arena: ${trialsLeft}</div>
          <div class="stimulus-container">
            <div class="stimulus-option">
              ${createFractalHTML(known)}
              <p style="font-size: 16px; font-weight: bold;">${known.reward_range[0]}â€“${known.reward_range[1]} Points</p>
              <p><strong>F: ACCEPT REWARD</strong></p>
            </div>
            <div class="stimulus-option">
              ${createFractalHTML(unknown)}
              <p style="font-size: 18px; font-weight: bold;">???</p>
              <p><strong>J: REVEAL REWARD</strong></p>
            </div>
          </div>
        `;
      },
      choices: ['f', 'j'],
      data: {
        trial_type: 'choice',
        trial_number: i
      },
      on_finish: function(data) {
        const props = jsPsych.data.get().last(1).values()[0];
        const known = props.current_known;
        const unknown = props.current_unknown;
        
        if (!known || !unknown) {
          data.error = "Missing stimulus data";
          return;
        }
        
        data.known_stimulus = known.id;
        data.known_range = known.reward_range;
        data.unknown_stimulus = unknown.id;
        
        if (data.response === 'j') {
          // Chose to reveal unknown
          const assigned_range = assignRewardRange();
          unknown.unlocked = true;
          unknown.reward_range = assigned_range;
          unlocked_stimuli.push(unknown);
          
          data.choice = 'reveal';
          data.revealed = true;
          data.assigned_range = assigned_range;
          data.points_awarded = 0;
          
          console.log(`Trial ${i}: Revealed ${unknown.id} with range [${assigned_range[0]}, ${assigned_range[1]}]`);
        } else {
          // Chose known reward
          const [min, max] = known.reward_range;
          const points = Math.floor(Math.random() * (max - min + 1)) + min;
          
          data.choice = 'accept';
          data.revealed = false;
          data.points_awarded = points;
          
          console.log(`Trial ${i}: Accepted ${known.id}, awarded ${points} points`);
        }
      }
    });

    // Feedback after each trial
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const lastTrial = jsPsych.data.get().last(1).values()[0];
        let feedback = "";
        
        if (lastTrial.choice === 'reveal') {
          const range = lastTrial.assigned_range;
          feedback = `
            <div style="text-align: center;">
              <h3>New Stimulus Unlocked!</h3>
              <p>This fractal will give you <strong>${range[0]} to ${range[1]} points</strong> in future trials.</p>
              <p>You gained <strong>0 points</strong> this trial.</p>
            </div>
          `;
        } else {
          feedback = `
            <div style="text-align: center;">
              <h3>Reward Collected!</h3>
              <p>You earned <strong>${lastTrial.points_awarded} points</strong> this trial.</p>
            </div>
          `;
        }
        
        feedback += `
          <p style="text-align: center;"><em>Press any key to continue</em></p>
        `;
        
        return feedback;
      },
      choices: "ALL_KEYS"
    });
  }

  // Arena instructions
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
      const known_count = unlocked_stimuli.filter(s => s.unlocked).length;
      const unknown_count = 42 - known_count;
      
      return `
        <div style="text-align: center; max-width: 600px; margin: 0 auto;">
          <h2>Welcome to the Arena!</h2>
          <p>Now you can choose from all 42 fractals arranged in a 6x7 grid.</p>
          <p><strong>Available options:</strong></p>
          <p>â€¢ ${known_count} Known fractals (showing point ranges)</p>
          <p>â€¢ ${unknown_count} Unknown fractals (showing "???")</p>
          <p><strong>Select exactly 3 fractals</strong> to maximize your points.</p>
          <p>Click on fractals to select them (they'll turn blue when selected).</p>
          <p>Unknown fractals will reveal their point ranges when selected!</p>
          <p><em>Press any key to enter the Arena</em></p>
        </div>
      `;
    },
    choices: "ALL_KEYS"
  });

  // Arena trial
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
      // Assign reward ranges to unknown stimuli that haven't been unlocked yet
      all_stimuli.forEach(stim => {
        if (!stim.unlocked && !stim.reward_range) {
          stim.reward_range = assignRewardRange();
        }
      });

      // Shuffle all stimuli for random display in grid
      const shuffled_stimuli = jsPsych.randomization.shuffle([...all_stimuli]);
      
      let html = `
        <h2 style="text-align: center;">Arena - Select 3 Fractals</h2>
        <div id="selection-counter" style="text-align: center; margin: 10px 0;">
          <p>Selected: <span id="count">0</span>/3</p>
        </div>
        <div class="arena-grid" id="arena">
      `;
      
      // Add all stimuli in 6x7 grid
      shuffled_stimuli.forEach((stim, index) => {
        const isKnown = stim.unlocked;
        const statusClass = isKnown ? 'known' : 'unknown';
        const statusText = isKnown ? 'KNOWN' : 'UNKNOWN';
        const pointsText = isKnown ? `${stim.reward_range[0]}â€“${stim.reward_range[1]} pts` : '???';
        
        html += `
          <div class="arena-fractal ${statusClass}" data-index="${index}">
            ${createFractalHTML(stim, 80)}
            <p style="margin: 3px 0; font-size: 10px; font-weight: bold;">${statusText}</p>
            <p style="margin: 3px 0; font-size: 11px; font-weight: bold;" id="points-${index}">${pointsText}</p>
          </div>
        `;
      });
      
      html += `</div>`;
      html += `
        <div id="arena-submit" style="text-align: center; margin-top: 20px; display: none;">
          <button id="submit-selection" style="padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Submit Selection</button>
        </div>
      `;
      
      return html;
    },
    choices: "NO_KEYS",
    on_load: function() {
      let selectedItems = [];
      const shuffled_stimuli = jsPsych.randomization.shuffle([...all_stimuli]);
      
      document.querySelectorAll(".arena-fractal").forEach((item, itemIndex) => {
        item.addEventListener("click", () => {
          const index = parseInt(item.dataset.index);
          const stimulus = shuffled_stimuli[index];
          const itemId = `stimulus_${index}`;
          
          if (selectedItems.find(si => si.id === itemId)) {
            // Deselect
            selectedItems = selectedItems.filter(si => si.id !== itemId);
            item.classList.remove('selected');
          } else if (selectedItems.length < 3) {
            // Select
            if (!stimulus.unlocked) 
            
            
            selectedItems.push({
              id: itemId,
              stimulus: stimulus
            });
            
            item.classList.add('selected');
          }
          
          // Update counter
          document.getElementById("count").textContent = selectedItems.length;
          
          // Show/hide submit button
          document.getElementById("arena-submit").style.display =
            selectedItems.length === 3 ? "block" : "none";
        });
      });
      
      document.getElementById("submit-selection").addEventListener("click", () => {
        // Calculate points for each selection
        const points = selectedItems.map(item => {
          const [min, max] = item.stimulus.reward_range;
          return Math.floor(Math.random() * (max - min + 1)) + min;
        });
        
        const totalPoints = points.reduce((a, b) => a + b, 0);
        
        jsPsych.finishTrial({
          trial_type: 'arena',
          selected_stimuli: selectedItems.map(item => item.stimulus.id),
          selected_was_known: selectedItems.map(item => item.stimulus.unlocked),
          selected_ranges: selectedItems.map(item => item.stimulus.reward_range),
          awarded_points: points,
          total_points: totalPoints
        });
      });
    }
  });

  // Final results
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
      const arena_data = jsPsych.data.get().last(1).values()[0];
      const allData = jsPsych.data.get().values();
      const totalPointsEarned = allData
        .filter(trial => trial.points_awarded)
        .reduce((sum, trial) => sum + trial.points_awarded, 0);
      
      const knownSelected = arena_data.selected_was_known.filter(k => k === true).length;
      const unknownSelected = arena_data.selected_was_known.filter(k => k === false).length;
      
      return `
        <div style="text-align: center; max-width: 600px; margin: 0 auto;">
          <h2>Experiment Complete!</h2>
          <h3>Arena Results:</h3>
          <p>You selected ${knownSelected} known and ${unknownSelected} unknown fractals</p>
          <p>You earned <strong>${arena_data.total_points}</strong> points in the Arena!</p>
          <p>Individual selections: ${arena_data.awarded_points.join(', ')} points</p>
          <h3>Total Experiment Points:</h3>
          <p>Arena: <strong>${arena_data.total_points}</strong> points</p>
          <p>Learning phase: <strong>${totalPointsEarned}</strong> points</p>
          <p><strong>Grand Total: ${totalPointsEarned + arena_data.total_points} points</strong></p>
          <br>
          <p>Thank you for participating!</p>
        </div>
      `;
    },
    choices: ['View Data', 'Finish']
  });

  // Run the experiment
  jsPsych.run(timeline);
</script>
</html>
